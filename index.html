<?php
session_start();

// Vérifie si l'utilisateur vient de l'inscription
if(!isset($_SESSION['inscrit']) || $_SESSION['inscrit'] !== true){
    header("Location: register.php");
    exit;
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Quiz – Jeu Alliance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --violet: #A42D88;
  --bleu: #13B7DE;
  --vert: #00ff88;
  --fond: #A42D88;
  --texte: #13B7DE;
  --btn-bg: #333;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  background: var(--fond);
  color: var(--texte);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}

.container {
  background: #222;
  padding: 40px 30px;
  border-radius: 20px;
  box-shadow: 0 15px 40px rgba(0,255,136,0.3);
  width: 100%;
  max-width: 650px;
  text-align: center;
  margin-bottom: 30px; /* espace entre container et réponses */
}

h1.quiz-title {
  font-size: 2rem;
  line-height: 1.3;
  background: linear-gradient(90deg,var(--bleu),var(--vert));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.answers-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
}

.answers-container button {
  padding: 18px;
  border-radius: 15px;
  background: var(--btn-bg);
  color: var(--texte);
  cursor: pointer;
  font-size: 1.2rem;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(0,255,136,0.2);
  text-align: center;
}

.answers-container button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px var(--vert);
}

.answers-container button.selected.correct {
  background: var(--vert);
  color: #000;
  box-shadow: 0 0 25px var(--vert);
}

.answers-container button.selected.wrong {
  background: var(--rouge);
  color: #fff;
  box-shadow: 0 0 25px var(--rouge);
}

.progress {
  height: 8px;
  background: var(--vert);
  width: 0%;
  border-radius: 4px;
  margin-bottom: 20px;
  transition: width 0.5s ease;
  max-width: 650px;
}
.next-btn {
  padding: 16px 25px;
  background: var(--vert);
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.next-btn:hover {
  background: var(--bleu);
  color: #000;
  transform: scale(1.05);
}
</style>
</head>
<body>

<div class="progress" id="progress"></div>

<div class="container">
  <h1 class="quiz-title" id="question"></h1>
</div>

<div class="answers-container"></div>

<script>
let current = 0, score = 0;

const questions = [
  {q: "En quelle année l'alliance CFE UNSA Energies est née en signant un protocole d'accord electoral ?", a: ["2006", "2009", "2010" ,"2012"], correct: 1},
  {q: "Quel est l’objectif principal de l’Alliance ?", a: ["Augmenter le nombre de sièges au CSE uniquement", "Fusionner tous les syndicats" , "Être plus influent pour mieux défendre les adhérents"], correct: 2},
  {q: "Être représentatif permet principalement de :", a: ["Communiquer davantage", "Désigner DS et signer des accords", "Faire plus d’affiches"], correct: 1},
  {q: "Quel est le seuil minimal d’audience pour être représentatif dans les IEG ?", a: ["5%", "8%" ,"10%" , "15%"], correct: 2},
  q: "Un syndicat catégoriel peut-il signer seul un accord à plus de 50% ?", a: ["Oui", "Non"], correct: 1},
  {q: "L’Alliance permet surtout de :", a: ["Multiplier les moyens syndicaux", "Fusionner les organisations"], correct: 0},
  {q: "Modifier la clé de répartition impacte :", a: ["Le nombre d’élus", "La représentativité"], correct: 1},
  {q: "Être représentatif permet aussi de :", a: ["Déposer un préavis de grève", "Créer un nouveau syndicat"], correct: 0},
  {q: "L’objectif stratégique de l’Alliance est :", a: ["Augmenter l’influence et la défense des salariés", "Changer les règles électorales"], correct: 0},
];

const questionEl = document.getElementById("question");
const answersContainer = document.querySelector(".answers-container");
const progress = document.getElementById("progress");

function loadQuestion() {
  const q = questions[current];
  questionEl.innerText = q.q;
  answersContainer.innerHTML = "";
  q.a.forEach((ans, idx) => {
    const btn = document.createElement("button");
    btn.innerText = ans;
    btn.onclick = () => answer(idx === q.correct, btn);
    answersContainer.appendChild(btn);
  });
  progress.style.width = ((current)/questions.length)*100 + "%";
}

function answer(isCorrect, btn){
  btn.classList.add("selected");
  if(isCorrect){
    btn.classList.add("correct");
    score++;
  } else {
    btn.classList.add("wrong");
  }

  answersContainer.querySelectorAll("button").forEach(b => b.disabled = true);

  setTimeout(() => {
    current++;
    if(current < questions.length){
      loadQuestion();
    } else {
      questionEl.innerText = "Quiz terminé ! Score : " + score + " / " + questions.length;
      answersContainer.innerHTML = `<button class="next-btn" onclick="restartQuiz()">Rejouer</button>`;
      progress.style.width = "100%";

      // Envoie du score au serveur
      fetch('save_score.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({score: score})
      })
      .then(res => res.json())
      .then(data => {
        console.log('Score enregistré', data);
        showLeaderboard();
      });
    }
  }, 500);

}

function showLeaderboard() {
  fetch('get_leaderboard.php')
    .then(res => res.json())
    .then(data => {
      let leaderboard = document.createElement('div');
      leaderboard.style.marginTop = '30px';
      leaderboard.style.maxWidth = '500px';
      leaderboard.style.width = '100%';
      leaderboard.style.background = '#222';
      leaderboard.style.padding = '20px';
      leaderboard.style.borderRadius = '15px';
      leaderboard.innerHTML = "<h2>Classement</h2>";
      
      data.forEach((row, idx) => {
        let div = document.createElement('div');
        div.innerText = `${idx+1}. ${row.username} - ${row.score}`;
        div.style.marginBottom = '10px';
        leaderboard.appendChild(div);
      });

      document.body.appendChild(leaderboard);
    });
}


function restartQuiz(){
  current = 0;
  score = 0;
  loadQuestion();
}

loadQuestion();
</script>

</body>
</html>
